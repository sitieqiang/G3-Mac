# 7.5.3.1 连接
>在G3标准中该部分不相关，也就是未使用
<br>- 连接在本文件第5.5款中有充分说明。

　　设备要先发送MLME-RESET.request原语命令来对MAC层复位，其参数SetDefaultPIB设置为TRUE，然后完成主动信道扫描（见7.5.2.1.2节）或者被动信道扫描（见7.5.2.1.3节），此时才能进行连接。信道扫描的结果用来选择一个合适的PAN。从信道扫描过程返回的PAN描述符列表中选择合适的所连接的PAN的算法超出了本标准的介绍范围。
选择所连接的PAN之后，上层将通过MLME-ASSOCIATE.request原语命令请求MLME对有关物理层和MAC层PIB属性进行如下配置：

　　——phyCurrentChannel设置为与MLME-ASSOCIATE.request原语命令中的LogicalChannel参数相等。

　　——phyCurrentPage设置为与MLME-ASSOCIATE.request原语命令中的ChannelPage参数相等。

　　——macPANId应设置为与MLME-ASSOCIATE.request原语命令中的CoordPANId参数相等。

　　——macCoordExtendedAddress或macCoordShortAddress，取决于要连接的协调器的信标帧，将其设置为与MLME-ASSOCIATE.request原语命令中的CoordAddress参数相等。

　　只有当macAssociationPermit设置为TRUE时协调器才允许连接。同样，设备只有在协调器当前允许连接时才能通过该协调器连接到PAN,正如扫描结果指示的那样。如果协调器接收到设备的连接请求命令，但其macAssociationPermit设置为FALSE，则将忽略此命令。

　　为了优化支持信标的PAN的连接过程，设备可以提前开始跟踪它所要连接的协调器的信标。上层通过发送MLME-SYNC.request原语命令来实现这个目的，其中TrackBeacon参数设置为TRUE。设备通过MLME-ASSOCIATE.request原语请求同一个已存在的PAN进行连
接，而不是企图启动它自己的PAN.

　　非连接设备的MAC层通过向已存在的PAN协调器发送连接请求命令（见7.3.1节）来初始化连接过程。如果因信道访问失败而不能发送连接请求命令，MAC层将通报上层。因为连接请求命令含有一个确认请求（见7.3.1），所以协调器应发送一个确认帧来确认接收。

　　连接请求命令的确认并不意味着设备已连接成功。协调器的上层需要时间来决定PAN的当前可用资源是否足够允许另一个设备的接入。上层将在macResponseWaitTime符号时间内做出决定。如果协调器的上层发现此设备之前已经连接到本PAN上，则将删除所有之前所获得的设备信息。如果有足够的可用资源，上层将给设备分配一个16为短地址，并且MAC层将产生一个包含新的地址和表示成功连接状态的连接响应命令（见7.3.2）。如果资源不足，协调器的上层将通知MAC层，MLME将产生一个包含表示失败状态的连接响应命令（见表83）。用间接发送的方式，将连接相应命令发送给请求连接的设备，即将连接响应命令帧添加到协调器的未决处理列表中，并由设备使用7.5.6.3节中描述的方法进行处理。

　　如果连接响应命令性能信息字段（见7.3.1.2节）的分配地址子字段为1，协调器的上层将分配一个16位的地址，其范围根据协调器所支持的寻址模式而定，如表87节所示。如果连接响应命令的分配地址子字段为0，该16位短地址等于0xfffe。短地址0xfffe为特殊情况，表示设备已经连接，但还没有分配短地址。在这种情况下，设备只能用其64位扩展地址在网络内工作。

　　设备一旦收到连接响应命令的确认之后，最多等待macResponseWaitTime符号，以便让协调器作出连接决定。PIB属性macResponseWaitTime是随网络拓扑结构而定的参数，用来匹配该设备将要连接的网络的具体要求。如果设备跟踪信标，它将试图从协调器的信标帧中提取连接响应命令。如果设备没有跟踪信标，它将在macResponseWaitTime符号之后，试图从协调器中提取连接响应命令。如果设备在macResponseWaitTime符号之内没有从协调器中提取到连接响应命令，MLME将发送带有NO_DATA状态的MLME-ASSOCIAYE.confirm原语，表明连接的尝试失败。在这种情况下，上层将通过发送TrackBeacon参数设置为FALSE的MLME-SYNC.request原语命令来终止信标跟踪。

　　由于连接响应命令含有一个确认请求（见7.3.2.1），所以请求连接的设备应发送一个确认帧来确认接收。如果该命令的连接状态字段表明连接成功，设备将把包含在该命令的16为短地址字段中的地址存储在macShortAddress中。PAN中使用此短地址的通信将取决于表87所描述的范围。如果选来连接的原始信标紧接着包含在协调器短地址中的扫描，包含在连接响应命令帧的MHR中的协调器扩展地址将被存储在macCoordExtendedAddress中。

<center>表87 16位短地址的使用</center>

macShortAddress的值|描述
----|----
0x0000-0xfffd|对于信标帧和数据帧，设备将使用短源寻址模式；对于MAC命令帧，设备将使用7.3中节所述的适当源寻址模式
0xfffe|对于信标帧和数据帧，设备将使用扩展源寻址模式；对于MAC命令帧，设备将使用7.3中节所述的适当源寻址模式
0xffff|设备未连接，不能进行任何数据帧通信；对于MAC命令帧，设备将使用7.3中节所述的适当源寻址模式

　　如果命令的连接状态字段表明连接不成功，设备将把macPANId设置为缺省值（0xffff）。
