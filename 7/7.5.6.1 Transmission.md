# 7.5.6.1 发送
>在G3标准中该部分作为规范

　　每个设备将把它当前的DSN值存储在MAC层PIB属性macDSN中，然后将其初始化为一个随机值。选择随机数的算法超出了本标准的范围。每次产生一个数据帧或者一个MAC命令帧，MAC层将把macDSN的值复制到输出帧MHR的序列号码字段中，然后将其加1。每一个设备都只产生一个DSN，不管它所希望与之通信的设备数是多少。macDSN的值允许循环。

　　每一个协调器应把它当前的BSN值存储在MAC层PIB属性macBSN中，然后将其初始化为一个随机值。选择随机数的算法超出了本标准的范围。每一次产生信标帧，MAC层将把macBSN的值复制到输出帧MHR的序列号码字段中，然后将其加1。macBSN的值允许循环。

　　值得注意的是，DSN和BSN都只有8位，因此对于上层来说其用途有限（例如在检测转发帧时的DSN）。

　　如果存在源地址字段，将包含发送帧的设备地址。当一个设备已经连接并且分配有一个16位的短地址（即macShortAddress的值不等于0xfffe或者0xffff）时，它将尽可能的优先使用此短地址，而不是64位的扩展地址（即aExtendedAddress）。当设备没有连接到PAN或者其macShortAddress的值等于0xffff时，它将在所有需要源地址字段的通信中使用其64位的扩展地址。如果源地址字段不存在，则认为帧的发送设备为PAN协调器，目标地址字段中应包含接收者的设备地址。

　　如果存在目标地址字段，应包含帧的目标接收者的地址，该值可能为16位的短地址，也可能为64位的扩展地址。如果不存在目标地址字段，则认为帧的接收设备为PAN协调器，源地址字段中应包含发送者的地址。

　　如果目标和源寻址信息都存在，MAC层将对目标和源PAN标识符进行比较。如果二者的PAN标识符相同，帧控制字段中的PANID密集子字段将设置为1，在发送帧中将忽略源PAN标识符。如果二者的PAN标识符不相同，帧控制字段中的PANID密集子字段将设置为0，发送帧中将包含目标和源PAN标识符字段。如果只存在目标和源寻址信息这二者中的一个，帧控制字段中的PANID密集子字段将设置为0，发送帧中将包含该唯一地址的PAN标识符字段。

　　在支持信标的PAN中发送帧信息，发送设备在发送之前应尝试找到信标。如果没有跟踪到信标（见7.5.4.1节），设备不知道信标在何处出现，因此它将打开接收机并搜索信标，最多持续搜索时间为 $aBaseSuperframeDuration * (2^n + 1)$ 符号，其中n为macBeaconOrder的值。如果在这段时间后没有发现信标，设备将在成功执行非时隙CSMA-CA算法之后（见7.5.1.4）发送帧。无论是经过搜索还是跟踪之后发现了信标，设备将在超帧的适当部分发送帧。在竞争期发送帧时，应该在时隙CSMA-CA算法成功执行之后（见7.5.1.4）发送帧，在保护时隙中发送帧不使用CSMA-CA算法。

　　如果在不支持信标的PAN中发送帧信息，则应在成功执行非时隙CSMA-CA算法之后（见7.5.1.4）发送帧。

　　不管是支持信标的PAN还是不支持信标的PAN，如果传输是直接的，由上层发送的原语引发，并且CSMA-CA算法失败，上层将得到通知。如果传输是间接的并且CSMA-CA算法失败，帧将会一直保留在事务队列中直到再次请求并且被成功发送，或者直到该事务溢出。

　　设备将按照7.5.8.2.1节中所述使用输出帧安全过程处理帧信息。

　　如果输出帧安全过程的状态不是SUCCESS，MLME将发送相应确认原语或者MLME-COMM-STATUS.indication原语，状态参数设置为输出帧安全过程中指示的错误状态。

　　为了发送帧，MAC层将通过向物理层发送状态为TX_ON的PLME-SET-TRX-STATE.request原语来打开发射机。在接收到状态为SUCCESS或者TX_ON的PLME-SET-TRX-STATE.confirm原语后，将通过发送PD-DATA.request原语来发送帧。最后，在接收到PD-DATA.confirm原语后，MAC层将通过给物理层发送状态为RX_ON或者TRX_OFF的PLME-SET-TRX-STATE.request原语来关闭发射机，取决于接收机是否将在发送之后打开。当帧控制字段的请求确认子字段设置为1时，MAC层将立即在帧发送之后，通过向物理层发送状态为RX_ON的PLME-SET-TRX-STATE.request原语来打开接收机。
